services:
  1mcp:
    image: ghcr.io/1mcp-app/agent:latest
    container_name: 1mcp-agent
    volumes:
      - ./mcp.json:/usr/src/app/mcp.json:ro
      - ./logs:/usr/src/app/logs
    environment:
      ONE_MCP_HOST: "0.0.0.0"
      ONE_MCP_PORT: "3050"
      ONE_MCP_CONFIG: "/usr/src/app/mcp.json"
      ONE_MCP_LOG_LEVEL: "info"
      ONE_MCP_ENABLE_ENV_SUBSTITUTION: "true"
      ONE_MCP_ENABLE_CONFIG_RELOAD: "true"
      # Secrets passed through for ${VAR} substitution in mcp.json
      SEMAPHORE_MCP_TOKEN: ${SEMAPHORE_MCP_TOKEN:?Set in .env}
      SHORTCUT_API_TOKEN: ${SHORTCUT_API_TOKEN:?Set in .env}
      NEW_RELIC_API_KEY: ${NEW_RELIC_API_KEY:?Set in .env}
      NEW_RELIC_ACCOUNT_ID: ${NEW_RELIC_ACCOUNT_ID:?Set in .env}
      JAM_MCP_TOKEN: ${JAM_MCP_TOKEN:?Set in .env}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3050/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  proxy:
    image: nginx:alpine
    container_name: 1mcp-proxy
    volumes:
      - ./proxy/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
    environment:
      MCP_PROXY_TOKEN: ${MCP_PROXY_TOKEN:?Set in .env}
    ports:
      - "127.0.0.1:9494:8080"
    depends_on:
      1mcp:
        condition: service_healthy
    restart: unless-stopped
